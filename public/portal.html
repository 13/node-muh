<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Portal</title>
  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/5.3.45/css/materialdesignicons.min.css">
  <!-- Load polyfills to support older browsers -->
  <script src="//polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver" crossorigin="anonymous"></script>
  <!-- Load Vue followed by BootstrapVue -->
  <!-- dev mode -->
  <script src="//unpkg.com/vue@latest/dist/vue.js"></script>
  <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
  <!-- production mode 
  <script src="//unpkg.com/vue@latest/dist/vue.min.js"></script>
  <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>-->
  <!-- Load the following for BootstrapVueIcons support -->
  <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>
  <!-- include socket.io client side script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
  <style type="text/css">
	.socketstatus { height: 4px !important; }
	.dotstatus { 
		display: inline-block; 
		height: .75em !important; 
		width: .75em !important; 
		margin-right: 0.25em !important; 
	}
	.a-is-half { width:50%; }
	.a-is-full { width:100%; }
	.column-padding { 
		padding-left: .27rem; 
		padding-right:.27rem;
	}
	.modal-center { margin: 0 auto; }
  </style>

</head>
<body>
<div id="app">

  <section class="section is-main-section">
    <div class="card mb-3">
      <div class="card-header">
          <span class="icon"><i class="mdi mdi-lock"></i></span>
		  <span class="font-weight-bold">Portal</span>
      </div>
      <div class="card-body">
 
	    <div class="container-fluid">
			<div class="row">
				<div class="col m-0 p-0">
					<p class="socketstatus alert m-0 p-0" v-bind:class="stateToTag(socketState)"></p>
				</div>
			</div>
		</div>
	
		<ul class="list-group">
		<div v-for="(portal, idx) in portals" :key="idx">
			<!-- portal header -->
			<li class="list-group-item bg-light" v-if="!portal.name.includes('lock')">
				<div class="row" v-if="!portal.name.includes('lock')" v-bind:class="{ 'bg-light': !portal.name.includes('lock') }">
					<div class="col font-weight-bold pr-0">{{ portals[idx].name | translateName }}</div>
					<div class="col-8 text-right pl-0">
						<div class="badge bg-white text-dark border" v-if="!portal.name.includes('lock')">{{ portal.tstamp | shortdate }}</div>
						<div class="badge bg-white text-dark border" v-if="!portal.name.includes('lock') && portal.name !== 'garage'">{{ portals[incrementItem(idx)].tstamp | shortdate }}</div>
					</div>
				</div>
			</li>
			<!-- portal footer -->
			<li class="list-group-item" v-if="!portal.name.includes('lock')" v-bind:class="{ 'border-bottom-0': portal.name !== 'garage' }">
				<div class="row font-weight-bold" v-if="!portal.name.includes('lock')" v-bind:class="{ 'has-background-white': !portal.name.includes('lock') }">
					<a v-b-modal="portal.name" v-bind:class="portal.name === 'garage' ? 'a-is-full' : 'a-is-half'">
						<div class="col">
							<span class="dotstatus m-0 p-0" v-bind:class="stateToTagVV(portal.state)"></span>{{ portal.state | translateDoorState }}
						</div>
					<!-- activate if different -->
					</a>
					<a v-b-modal="portals[incrementItem(idx)].name" class="a-is-half" v-if="!portal.name.includes('lock') && portal.name !== 'garage'">
						<div class="col" v-if="!portal.name.includes('lock') && portal.name !== 'garage'">
							<span class="dotstatus m-0 p-0" role="alert" v-bind:class="stateToTagVV(portals[incrementItem(idx)].state)"></span>{{ portals[incrementItem(idx)].state | translateDoorState }}
						</div>
					</a>
				</div>
			</li>
					
			<!-- modal -->
			<b-modal 
			  v-bind:id="portals[idx].name" 
			  v-bind:title="portals[idx].name | translateName" 
			  title-class="modal-center font-weight-bold"
			  header-bg-variant="light"
			  hide-header-close 
			  hide-footer
			  centered
			>
				<div class="container">
					<div class="row">
						<div class="col">
							<b-button variant="light border font-weight-bold" block>
								<span class="icon">
									<i class="mdi mdi-door-open"></i>
								</span>
								<span>Öffnen</span>
							</b-button>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<b-button variant="light border font-weight-bold" class="mt-3" block>
								<span class="icon">
									<i class="mdi mdi-lock"></i>
								</span>
								<span>Verriegeln</span>
							</b-button>
						</div>
						<div class="col">
							<b-button variant="light border font-weight-bold" class="mt-3" block>
								<span class="icon">
									<i class="mdi mdi-lock-open-variant"></i>
								</span>
								<span>Entriegeln</span>
							</b-button>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<b-button variant="light border font-weight-bold" class="mt-3" block @click="$bvModal.hide(portals[idx].name)">Abbrechen</b-button>
						</div>
					</div>
				</div>
			</b-modal>
		</div>
		</ul><!-- end -->
		
      </div>
    </div>
  </section>  
  
</div>  


<script>
"use strict"

var socket = io('/portal'); //load socket.io-client and connect to the host that serves the page

// vue.js
var app = new Vue({
  el: '#app',
  data: {
    socketState: false,
    isHidden: false,
    json: null,
    portals: []
  },
  mounted: function () {
    this.$nextTick(function () {
	// ...
    })
  },
  filters: {
    space (value) {
      return (value ? 'on' : 'off')
    },
    short (value) {
      return value.substr(0, value.indexOf('.'))
    },
	translateDoorState (value) {
      return (value ? 'GESCHLOSSEN' : 'OFFEN')
    },
    shortdate (value) {
		var date_now = new Date();
		var date_past = new Date(value);
		var days = date_past.getDate();
		var months = date_past.getMonth()+1;
		var hours = date_past.getHours();
		var minutes = date_past.getMinutes();
		
		days = days < 10 ? '0'+days : days;
		months = months < 10 ? '0'+months : months;
		hours = hours < 10 ? '0'+hours : hours;
		minutes = minutes < 10 ? '0'+minutes : minutes;
		var strDate = days + '.' + months + '.';
		var strTime = hours + ':' + minutes;
		
		var diff = date_now.getTime() - date_past.getTime();
		var diff_hours = Math.floor(diff / (1000 * 60 * 60));

		return ((diff_hours > 22) ? strDate + " " + strTime : strTime);
    },
	translateName(value){
	    var txt;
		switch (value) {
			case "housedoor":
			  txt = "Haustür";
			  break;
			case "garagedoor":
			  txt = "Garagentür";
			  break;
			case "garage":
			  txt = "Garage";
			  break;
			default:
			  txt = value;
		}
		return txt;
	}
  },
  methods: {
	getRealtimeData() {
		socket.on('portal', json => { //get button status from client
			this.json = json,
			this.portals = json.portals;
			this.socketState = true;
			console.log("socket connect: " + this.socketState);
		}),
		socket.on('disconnect', socketState => {
			this.socketState = false
			console.log('socket disconnect: ' + socketState);
		});
	},
	stateToTag(value){
		return (value ? 'bg-success' : 'bg-danger')
	},
	stateToTagVV(value){
		return (value ? 'bg-danger' : 'bg-success')
	},
	capitalizeFirstLetter(value) {
		return value.charAt(0).toUpperCase() + value.slice(1)
	},	
	incrementItem: function(item) {return item + 1},
	warn: function (message, event) {
		// now we have access to the native event
		if (event) {
			event.preventDefault()
    	}
		console.log(message)
        socket.emit("wakemac", message); //send push button status to back to server
  	},
	cancel() {
      this.$refs.modal.close("button");
    },
	nameToModalID(prop){
		//var modalName = "is" + prop.charAt(0).toUpperCase() + prop.slice(1) + "ModalActive"
	    //console.log(modalName)
		//this[modalName]
		//return modalName
		console.log(prop)
		return prop
	},
  },
  created () {
	this.getRealtimeData()
  },
  /*computed: {
    fullName: function () {
      return this.firstName + ' ' + this.lastName
    }	
  }*/
})
</script>
</body>
</html>
