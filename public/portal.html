<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Portal</title>
		<!-- Load required Bootstrap and BootstrapVue CSS -->
		<link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
		<link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
		<link rel="stylesheet" href="https://cdn.materialdesignicons.com/5.3.45/css/materialdesignicons.min.css">
		<!-- Load polyfills to support older browsers -->
		<script src="//polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver" crossorigin="anonymous"></script>
		<!-- Load Vue followed by BootstrapVue -->
		<!-- dev mode -->
		<script src="//unpkg.com/vue@latest/dist/vue.js"></script>
		<script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
		<!-- production mode 
			<script src="//unpkg.com/vue@latest/dist/vue.min.js"></script>
		<script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>-->
		<!-- Load the following for BootstrapVueIcons support -->
		<script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>
		<!-- include socket.io client side script -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
		
		<style type="text/css">
			.socketstatus { height: 4px !important; }
			.pointer-disabled { pointer-events: none !important; }
			.modal-center { margin: 0 auto; }
			.rounded-top-0 {
				border-top-left-radius: 0px !important;
				border-top-right-radius: 0px !important;
			}
			.rounded-bottom-0 {
				border-bottom-right-radius: 0px !important;
				border-bottom-left-radius: 0px !important;
			}
			.rounded-left-0 {
				border-top-left-radius: 0rem !important;
				border-bottom-left-radius: 0rem !important;
			}
			.rounded-right-0 {
				border-top-right-radius: 0rem !important;
				border-bottom-right-radius: 0rem !important;
			}
			.border-trans {
				border: 1px solid rgba(0,0,0,.125);
			}
			/* sidebar */
			@media (min-width:768px) {
				.sidebar {
					width:14rem!important;
					min-height: 100vh;
					padding:0;
					border-right: 1px solid rgba(0,0,0,.125)
				}
				.nav-item {
					padding: .75rem 1.25rem;
				}
				.nav-link {
					padding: 0 !important;
				}
			}
			@media (max-width:576px) {
				.col-main {
					padding: 0 !important;
					border: none !important;
				}
			}
		</style>
		
	</head>
	<body>
		<div id="app">
			<b-navbar toggleable="lg" class="font-weight-bold text-dark bg-light navbar sticky-top flex-md-nowrap d-md-none">
				<b-navbar-brand href="/">muh</b-navbar-brand>
				<b-navbar-toggle target="nav-collapse"></b-navbar-toggle>	
			</b-navbar>
			<div class="container-fluid">
				<div class="row">
					
					<b-navbar toggleable="lg" class="sidebar col font-weight-bold text-dark bg-light d-inline-block align-top pb-0">
						<b-collapse id="nav-collapse" is-nav>
							<b-navbar-nav class="nav flex-column w-100">
								<b-nav-item href="dashboard">
									<span class="icon"><i class="mdi mdi-home"></i></span>
									Dashboard
								</b-nav-item>
								<b-nav-item href="portal">
									<span class="icon"><i class="mdi mdi-lock"></i></span>
									Portal
								</b-nav-item>								
								<b-nav-item href="cams">
									<span class="icon"><i class="mdi mdi-camera"></i></span>
									Cams
								</b-nav-item>
								<b-nav-item href="aufnahmen">
									<span class="icon"><i class="mdi mdi-image-multiple"></i></span>
									Aufnahmen
								</b-nav-item>
								<b-nav-item href="wol">
									<span class="icon"><i class="mdi mdi-lan"></i></span>
									WOL
								</b-nav-item>
								<b-nav-item href="weather">
									<span class="icon"><i class="mdi mdi-weather-partly-cloudy"></i></span>
									Wetter
								</b-nav-item>
								<b-nav-item href="solar">
									<span class="icon"><i class="mdi mdi-coolant-temperature"></i></span>
									Solar
								</b-nav-item>
								<b-nav-item href="temperaturen">
									<span class="icon"><i class="mdi mdi-thermometer"></i></span>
									Temperaturen
								</b-nav-item>
								<b-nav-item href="sounds">
									<span class="icon"><i class="mdi mdi-music"></i></span>
									Sounds
								</b-nav-item>
							</b-navbar-nav>
						</b-collapse>
					</b-navbar>
					
					<main role="main" class="col-main col-md-9 ml-sm-auto col-lg-10 px-md-4">
						<div class="card">
							<div class="card-header">
								<span class="icon"><i class="mdi mdi-lock"></i></span>
								<span class="font-weight-bold">Portal</span>
							</div>
							
							<div class="container-fluid">
								<div class="row">
									<div class="col m-0 p-0">
										<p class="socketstatus alert rounded-0 m-0 p-0" v-bind:class="stateToTagBg(socketState)"></p>
									</div>
								</div>
							</div>	  
							
							<div class="card-body">
								
								<div class="list-group" v-for="(portal, idx) in portals" :key="idx">
									<!-- portal header -->
									<a href="#" class="list-group-item list-group-item-action text-dark disabled bg-light"
									v-if="!portal.name.includes('lock')" v-bind:class="{ 'border-top-0 rounded-top-0': idx !== 0 }">
										<div v-if="!portal.name.includes('lock')" class="container-fluid p-0">
											<div class="row">
												<div class="col font-weight-bold pr-0">{{ portals[idx].name | translateName }}</div>
												<div class="col-8 text-right pl-0">
													<div v-if="!portal.name.includes('lock')" class="badge bg-white text-dark border" >{{ portal.tstamp | shortdate }}</div>
													<div v-if="!portal.name.includes('lock') && portal.name !== 'garage'" class="badge bg-white text-dark border">
														{{ portals[incrementItem(idx)].tstamp | shortdate }}
													</div>
												</div>
											</div>
										</div>
									</a>
									<!-- portal footer -->
									<div class="container-fluid" v-if="!portal.name.includes('lock')">
										<div v-if="!portal.name.includes('lock')" class="row font-weight-bold">
											<a v-b-modal="portal.name"
											class="list-group-item list-group-item-action pr-0 border-top-0"
											v-if="!portal.name.includes('lock')"
											v-bind:class="[isLastRounded(idx), stateToTagListBgVV(portal.state), halfOrFull(portal.name)]">
												<div class="col p-0">
													<span class="h6" v-bind:class="stateToTagVV(portal.state)">
														<b-icon icon="square-fill"></b-icon>
													</span>
													<span>{{ portal.state | translateDoorState }}</span>
												</div>
											</a>
											<a v-b-modal="portal.name"
											v-if="!portal.name.includes('lock') && portal.name !== 'garage'"
											class="list-group-item list-group-item-action pr-0 border-top-0 border-left-0"
											v-bind:class="[stateToTagListBgVV(portals[incrementItem(idx)].state), halfOrFull(portals[incrementItem(idx)].name)]">
												<div class="col p-0" v-if="!portal.name.includes('lock') && portal.name !== 'garage'">
													<span class="h6" v-bind:class="stateToTagVV(portals[incrementItem(idx)].state)">
														<b-icon icon="square-fill"></b-icon>
													</span>
													<span>{{ portals[incrementItem(idx)].state | translateDoorLockState }}</span>							
												</div>
											</a>
										</div>
									</div>	
									<!-- modal -->
									<b-modal 
									v-bind:id="portals[idx].name" 
									v-bind:title="portals[idx].name | translateName" 
									title-class="modal-center font-weight-bold"
									header-bg-variant="light"
									hide-header-close 
									hide-footer
									centered
									>
										<!-- Doors -->
										<div class="container" v-if="portal.name !== 'garage'">
											<b-alert
											:show="dismissCountDown"
											variant="warning"
											@dismissed="dismissCountDown=0"
											@dismiss-count-down="countDownChanged"
											>
												<p class="h6 text-center p-0 m-0 font-weight-bold">{{ notifymv }} ...</p>
												<!--<p class="h6 text-center p-0 m-0 font-weight-bold">{{ notifymv }} in {{ dismissCountDown }} ...</p>
													<b-progress
													variant="warning"
													:max="dismissSecs"
													:value="dismissCountDown"
													height="4px"
													animated
												></b-progress>-->
											</b-alert>
											<div class="row m-0 pb-3">
												<div class="col font-weight-bold btn pointer-disabled rounded-right-0 border-trans" v-bind:class="stateToTagListBgVV(portal.state)">
													<span class="h6 d-none d-sm-inline" v-bind:class="stateToTagVV(portal.state)">
														<b-icon icon="square-fill"></b-icon>
													</span>
													<span>{{ portal.state | translateDoorState }}</span>							
												</div>
												<div class="col font-weight-bold btn pointer-disabled rounded-left-0 border-trans border-left-0" v-bind:class="stateToTagListBgVV(portals[incrementItem(idx)].state)">
													<span class="h6 d-none d-sm-inline" v-bind:class="stateToTagVV(portals[incrementItem(idx)].state)">
														<b-icon icon="square-fill"></b-icon>
													</span>
													<span>{{ portals[incrementItem(idx)].state | translateDoorLockState }}</span>							
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="font-weight-bold border btn-light" block @click="notifyMvmnt(portals[idx].name, 'Öffnen', 2, $event)">
														<span class="icon">
															<i class="mdi mdi-door-open"></i>
														</span>
														<span class="font-weight-bold">Öffnen</span>
													</b-button>
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="font-weight-bold border btn-light" class="mt-3" block @click="notifyMvmnt(portals[idx].name, 'Verriegeln', 2, $event)">
														<span class="icon">
															<i class="mdi mdi-lock"></i>
														</span>
														<span class="font-weight-bold">Verriegeln</span>
													</b-button>
												</div>
												<div class="col">
													<b-button variant="font-weight-bold border btn-light" class="mt-3" block @click="notifyMvmnt(portals[idx].name, 'Entriegeln', 2, $event)">
														<span class="icon">
															<i class="mdi mdi-lock-open-variant"></i>
														</span>
														<span class="font-weight-bold">Entriegeln</span>
													</b-button>
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="light border font-weight-bold" class="mt-3" block @click="$bvModal.hide(portals[idx].name)">Abbrechen</b-button>
												</div>
											</div>
										</div>
										
										<!-- Garage -->
										<div class="container" v-else>
											<b-alert
											:show="dismissCountDown"
											variant="warning"
											@dismissed="dismissCountDown=0"
											@dismiss-count-down="countDownChanged"
											>
												<p class="h6 text-center p-0 m-0 font-weight-bold">{{ notifymv }} ...</p>
												<!--<p class="h6 text-center p-0 m-0 font-weight-bold">{{ notifymv }} in {{ dismissCountDown }} ...</p>
													<b-progress
													variant="warning"
													:max="dismissSecs"
													:value="dismissCountDown"
													height="4px"
													animated
												></b-progress>-->
											</b-alert>
											<div class="row m-0 pb-3">
												<div class="col font-weight-bold btn pointer-disabled border-trans" v-bind:class="stateToTagListBgVV(portal.state)">
													<span class="h6" v-bind:class="stateToTagVV(portal.state)">
														<b-icon icon="square-fill"></b-icon>
													</span>
													<span>{{ portal.state | translateDoorState }}</span>							
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="font-weight-bold btn-light border" block @click="notifyMvmnt(portals[idx].name, 'Bewegen', 2, $event)">
														<span class="icon">
															<i class="mdi mdi-arrow-up-down-bold"></i>
														</span>
														<span class="font-weight-bold">Bewegen</span>
													</b-button>
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="light border font-weight-bold" class="mt-3" block
													@click="$bvModal.hide(portals[idx].name)">Abbrechen</b-button>
												</div>
											</div>
										</div>				
										
									</b-modal>
								</div><!-- end -->
								
							</div>
						</div>
					</main>
					
				</div>
			</div>
			
		</div><!-- app -->
		<script>
			"use strict"
			
			var socket = io('/portal'); //load socket.io-client and connect to the host that serves the page
			
			// vue.js
			var app = new Vue({
				el: '#app',
				data: {
					socketState: false,
					isHidden: false,
					json: null,
					portals: [],
					notifymv: null,
					dismissSecs: 5,
					dismissCountDown: 0,
					showDismissibleAlert: false
				},
				mounted: function () {
					this.$nextTick(function () {
						// ...
					})
				},
				filters: {
					space (value) {
						return (value ? 'on' : 'off')
					},
					short (value) {
						return value.substr(0, value.indexOf('.'))
					},
					translateDoorState (value) {
						return (value ? 'GESCHLOSSEN' : 'OFFEN')
					},
					translateDoorLockState (value) {
						return (value ? 'VERRIEGELT' : 'ENTRIEGELT')
					},
					shortdate (value) {
						var date_now = new Date();
						var date_past = new Date(value);
						var days = date_past.getDate();
						var months = date_past.getMonth()+1;
						var hours = date_past.getHours();
						var minutes = date_past.getMinutes();
						
						days = days < 10 ? '0'+days : days;
						months = months < 10 ? '0'+months : months;
						hours = hours < 10 ? '0'+hours : hours;
						minutes = minutes < 10 ? '0'+minutes : minutes;
						var strDate = days + '.' + months + '.';
						var strTime = hours + ':' + minutes;
						
						var diff = date_now.getTime() - date_past.getTime();
						var diff_hours = Math.floor(diff / (1000 * 60 * 60));
						
						return ((diff_hours > 22) ? strDate + " " + strTime : strTime);
					},
					translateName(value){
						var txt;
						switch (value) {
							case "housedoor":
								txt = "Haustür";
								break;
							case "garagedoor":
								txt = "Garagentür";
								break;
							case "garagedoorlock":
								txt = "Garagentür";
								break;
							case "housedoorlock":
								txt = "Haustür";
								break;			  
							case "garage":
								txt = "Garage";
								break;
							default:
								txt = value;
						}
						return txt;
					}
				},
				methods: {
					getRealtimeData() {
						socket.on('portal', json => { //get button status from client
							this.json = json,
							this.portals = json.portals;
							this.socketState = true;
							console.log("socket connect: " + this.socketState);
						}),
						socket.on('disconnect', socketState => {
							this.socketState = false
							console.log('socket disconnect: ' + socketState);
						});
					},
					stateToTagListBgVV(value){
						//console.log("stateToTagListBg: " + value);
						return (!value ? 'list-group-item-success' : 'list-group-item-danger')
					},
					stateToTagBg(value){
						return (value ? 'bg-success' : 'bg-danger')
					},
					stateToTag(value){
						return (value ? 'text-success' : 'text-danger')
					},
					stateToTagVV(value){
						return (value ? 'text-danger' : 'text-success')
					},
					capitalizeFirstLetter(value) {
						return value.charAt(0).toUpperCase() + value.slice(1)
					},
					halfOrFull(value){
						//console.log("halfOrFull: " + value);
						var ret;
						switch (value) {	  
							case "garage":
							ret = "w-100";
							break;
							default:
							ret = "w-50";
						}
						return ret;
					},
					incrementItem: function(item) {return item + 1},
					warn: function (message, event) {
						// now we have access to the native event
						if (event) {
							event.preventDefault()
						}
						console.log("Waking " + message)
						socket.emit("wakemac", message) //send push button status to back to server
					},
					cancel() {
						this.$refs.modal.close("button");
					},
					isLast (index) {      
						return this.portals.length === index + 1
					},
					isLastRounded (index) {      
						return (this.isLast(index) ? 'rounded-bottom' : 'rounded-bottom-0')
					},
					notifyMvmnt: function (name, action, secs, event) {
						// now we have access to the native event
						if (event) {
							event.preventDefault()
						}
						//if (typeof mac !== 'undefined'){ 
						console.log(action + " " + name + " " + secs)
						//socket.emit("wakemac", mac); //send push button status to back to server
						//app.notifywol = "Waking " + hostname.substr(0, hostname.indexOf('.')) + " in " + this.dismissCountDown + " ..."
						//this.notifymv = hostname.substr(0, hostname.indexOf('.'))
						this.dismissSecs = secs
						this.notifymv = "... " + action + " "
						//setTimeout(() => this.isHidden = false, 5000)
						//setTimeout(() => this.notifywol = null, this.dismissSecs*1000+1000)
						//}
						this.dismissCountDown = this.dismissSecs
						//app.notifywol = null;
					},
					notifyMvmntCancel() {
						this.dismissSecs = 0
						this.dismissCountDown = 0
						this.showDismissibleAlert= false
					},
					countDownChanged(dismissCountDown) {
						this.dismissCountDown = dismissCountDown
					}
				},
				created () {
					this.getRealtimeData()
				},
				/*computed: {
					fullName: function () {
					return this.firstName + ' ' + this.lastName
					}	
				}*/
			})
		</script>
	</body>
</html>
