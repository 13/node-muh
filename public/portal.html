<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Portal</title>
		<!-- vuetify -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
		<link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
		<link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
		<!-- include socket.io client side script -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>	
	</head>
	<body>
		<div id="app">
		<v-app>
			<v-main>
				<v-card class="mx-auto">
					<!-- card header -->
				    <v-list-item>
						<v-list-item-icon>
							<v-icon>mdi-lock</v-icon>
						</v-list-item-icon>	
						<v-list-item-content>
							<v-list-item-title class="headline">Portal</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<!-- socket state -->
					<v-progress-linear
					  class="mb-0"
					  value="100"
					  v-bind:color="stateToTag(socketState)"
					></v-progress-linear>
					
					<!-- portal -->
					<v-list>
					<div v-for="(portal, idx) in portals" :key="idx">
						<v-list-item
						  v-if="!portal.name.includes('lock')"
						  @click=""
						>
							<!-- portal header -->
							<v-list-item-content v-if="!portal.name.includes('lock')">
								<v-list-item-title class="headline">
									{{ portals[idx].name | translateName }}
								</v-list-item-title>
							</v-list-item-content>
							<v-chip
							  label
							  small
							  v-if="!portal.name.includes('lock')"
							>
								{{ portal.tstamp | shortdate }}
							</v-chip>
							<v-chip
							  label
							  small
							  v-if="!portal.name.includes('lock') && portal.name !== 'garage'"
							>
								{{ portals[incrementItem(idx)].tstamp | shortdate }}
							</v-chip>
						</v-list-item>
									<!--<v-list-item-content v-if="!portal.name.includes('lock')">
										<v-container fluid v-if="!portal.name.includes('lock')" class="pa-0">
											<v-row no-gutters
											  align="center"
											  justify="center">
												<v-col :cols="3">{{ portals[idx].name | translateName }}</v-col>
												<v-col class="text-right">
													<v-chip
													  label
													  small
													  v-if="!portal.name.includes('lock')"
													>
													  {{ portal.tstamp | shortdate }}
													</v-chip>
													<v-chip
													  label
													  small
													  v-if="!portal.name.includes('lock') && portal.name !== 'garage'">
														{{ portals[incrementItem(idx)].tstamp | shortdate }}
													</v-chip>
												</v-col>
											</v-row>
										</v-container>
									<v-list-item-content>-->
									<!--</v-list-item-content>-->
									<!-- portal footer -->
									<!--
									<div class="container">
									<div class="row">
									<div class="col-md-6 col-12">
										<div class="v-card v-sheet v-sheet--outlined theme--light">
											<a href="/en/styles/flex/" class="v-list-item--doc v-list-item v-list-item--link theme--light primary--text" tabindex="0">
												<div class="v-avatar v-list-item__avatar deep-purple accent-4" style="height: 40px; min-width: 40px; width: 40px;">
													<i aria-hidden="true" class="v-icon notranslate mdi mdi-checkbox-blank theme--dark"></i>
												</div>
												<div class="v-list-item__content">
													<div class="v-list-item__title">
														<span>{{ portal.state | translateDoorState }}</span>
													</div>
												</div>
												<div class="v-list-item__action">
													<i aria-hidden="true" class="v-icon notranslate mdi mdi-arrow-right theme--light"></i>
												</div>
											</a>
										</div>
									</div>
									<div class="col-md-6 col-12">
										<div class="v-card v-sheet v-sheet--outlined theme--light">
											<a href="/en/customization/breakpoints/" class="v-list-item--doc v-list-item v-list-item--link theme--light primary--text" tabindex="0">
												<div class="v-avatar v-list-item__avatar red lighten-2" style="height: 40px; min-width: 40px; width: 40px;">
													<i aria-hidden="true" class="v-icon notranslate mdi mdi-checkbox-blank theme--dark"></i>
												</div>
												<div class="v-list-item__content">
													<div class="v-list-item__title">
														<span>breakpoints</span>
													</div>
													<div class="v-list-item__subtitle">
														<span>customization</span>
													</div>
												</div>
												<div class="v-list-item__action">
														<i aria-hidden="true" class="v-icon notranslate mdi mdi-arrow-right theme--light"></i>
												</div>
											</a>
										</div>
									</div>
									</div>
									</div>-->
									<!-- container new line -->
									<!--
									<v-container class="pa-0" v-if="!portal.name.includes('lock')">
										<v-row v-if="!portal.name.includes('lock')">
											<v-col class="pa-0">										
												<v-list-item-icon class="ma-0">
													<v-icon>mdi-checkbox-blank</v-icon>
												</v-list-item-icon>
												<v-list-item-content class="d-inline-flex">
													<v-list-item-title class="headline">
														{{ portal.state | translateDoorState }}
													</v-list-item-title>
												</v-list-item-content>
											</v-col>
											<v-col class="pa-0" v-if="!portal.name.includes('lock') && portal.name !== 'garage'">
												<v-list-item-icon class="ma-0">
													<v-icon>mdi-checkbox-blank</v-icon>
												</v-list-item-icon>
												<v-list-item-content class="d-inline-flex">
													<v-list-item-title class="headline">
														{{ portals[incrementItem(idx)].state | translateDoorLockState }}
													</v-list-item-title>
												</v-list-item-content>	
											</v-col>
										</v-row>
									</v-container>-->
									
										<!--<v-container fluid v-if="!portal.name.includes('lock')" class="pa-0">-->
										    <!--<v-row v-if="!portal.name.includes('lock')">
											 <a v-b-modal="portal.name"
											v-if="!portal.name.includes('lock')"
											v-bind:class="[stateToTagListBgVV(portal.state), halfOrFull(portal.name)]">
												<v-col class="col-md-6 col-12">
													<v-card>
														<v-icon v-bind:color="stateToTag(!portal.state)">mdi-checkbox-blank</v-icon>
														<span>{{ portal.state | translateDoorState }}</span>													
													</v-card>
												</v-col>
											</a>
											<a v-b-modal="portal.name"
											v-if="!portal.name.includes('lock') && portal.name !== 'garage'"
											v-bind:class="[stateToTagListBgVV(portals[incrementItem(idx)].state), halfOrFull(portals[incrementItem(idx)].name)]">
												<v-col class="col-md-6 col-12" v-if="!portal.name.includes('lock') && portal.name !== 'garage'">
													<v-icon v-bind:color="stateToTag(!portals[incrementItem(idx)].state)">mdi-checkbox-blank</v-icon>
													<span>{{ portals[incrementItem(idx)].state | translateDoorLockState }}</span>							
												</v-col>
											</a>
											</v-row>-->
										<!--</v-container>-->
								<!--</v-list-item-content>-->
									<!-- modal -->
									<!--<b-modal 
									v-bind:id="portals[idx].name" 
									v-bind:title="portals[idx].name | translateName" 
									title-class="modal-center font-weight-bold"
									header-bg-variant="light"
									hide-header-close 
									hide-footer
									centered
									>-->
										<!-- Doors 
										<div class="container" v-if="portal.name !== 'garage'">
											<b-alert
											:show="dismissCountDown"
											variant="warning"
											@dismissed="dismissCountDown=0"
											@dismiss-count-down="countDownChanged"
											>
										<p class="h6 text-center p-0 m-0 font-weight-bold">{{ notifymv }} ...</p>-->
												<!--<p class="h6 text-center p-0 m-0 font-weight-bold">{{ notifymv }} in {{ dismissCountDown }} ...</p>
													<b-progress
													variant="warning"
													:max="dismissSecs"
													:value="dismissCountDown"
													height="4px"
													animated
												></b-progress>-->
												<!--</b-alert>
											<div class="row m-0 pb-3">
												<div class="col font-weight-bold btn pointer-disabled rounded-right-0 border-trans" v-bind:class="stateToTagListBgVV(portal.state)">
													<span class="h6 d-none d-sm-inline" v-bind:class="stateToTagVV(portal.state)">
														<b-icon icon="square-fill"></b-icon>
													</span>
													<span>{{ portal.state | translateDoorState }}</span>							
												</div>
												<div class="col font-weight-bold btn pointer-disabled rounded-left-0 border-trans border-left-0" v-bind:class="stateToTagListBgVV(portals[incrementItem(idx)].state)">
													<span class="h6 d-none d-sm-inline" v-bind:class="stateToTagVV(portals[incrementItem(idx)].state)">
														<b-icon icon="square-fill"></b-icon>
													</span>
													<span>{{ portals[incrementItem(idx)].state | translateDoorLockState }}</span>							
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="font-weight-bold border btn-light" block @click="notifyMvmnt(portals[idx].name, 'Öffnen', 2, $event)">
														<span class="icon">
															<i class="mdi mdi-door-open"></i>
														</span>
														<span class="font-weight-bold">Öffnen</span>
													</b-button>
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="font-weight-bold border btn-light" class="mt-3" block @click="notifyMvmnt(portals[idx].name, 'Verriegeln', 2, $event)">
														<span class="icon">
															<i class="mdi mdi-lock"></i>
														</span>
														<span class="font-weight-bold">Verriegeln</span>
													</b-button>
												</div>
												<div class="col">
													<b-button variant="font-weight-bold border btn-light" class="mt-3" block @click="notifyMvmnt(portals[idx].name, 'Entriegeln', 2, $event)">
														<span class="icon">
															<i class="mdi mdi-lock-open-variant"></i>
														</span>
														<span class="font-weight-bold">Entriegeln</span>
													</b-button>
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="light border font-weight-bold" class="mt-3" block @click="$bvModal.hide(portals[idx].name)">Abbrechen</b-button>
												</div>
											</div>
												</div>-->
										
										<!-- Garage 
										<div class="container" v-else>
											<b-alert
											:show="dismissCountDown"
											variant="warning"
											@dismissed="dismissCountDown=0"
											@dismiss-count-down="countDownChanged"
											>
												<p class="h6 text-center p-0 m-0 font-weight-bold">{{ notifymv }} ...</p>-->
												<!--<p class="h6 text-center p-0 m-0 font-weight-bold">{{ notifymv }} in {{ dismissCountDown }} ...</p>
													<b-progress
													variant="warning"
													:max="dismissSecs"
													:value="dismissCountDown"
													height="4px"
													animated
												></b-progress>-->
												<!--</b-alert>
											<div class="row m-0 pb-3">
												<div class="col font-weight-bold btn pointer-disabled border-trans" v-bind:class="stateToTagListBgVV(portal.state)">
													<span class="h6" v-bind:class="stateToTagVV(portal.state)">
														<b-icon icon="square-fill"></b-icon>
													</span>
													<span>{{ portal.state | translateDoorState }}</span>							
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="font-weight-bold btn-light border" block @click="notifyMvmnt(portals[idx].name, 'Bewegen', 2, $event)">
														<span class="icon">
															<i class="mdi mdi-arrow-up-down-bold"></i>
														</span>
														<span class="font-weight-bold">Bewegen</span>
													</b-button>
												</div>
											</div>
											<div class="row">
												<div class="col">
													<b-button variant="light border font-weight-bold" class="mt-3" block
													@click="$bvModal.hide(portals[idx].name)">Abbrechen</b-button>
												</div>
											</div>
										</div>				
										
												</b-modal>-->
								</div>
								</v-list>

				</v-card>
			</v-main>
		</v-app>
		</div><!-- app -->
		
		<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
		<script>
			"use strict"
			
			var socket = io('/portal'); //load socket.io-client and connect to the host that serves the page
			
			// vue.js
			var app = new Vue({
				el: '#app',
				vuetify: new Vuetify(),
				data: {
					socketState: false,
					isHidden: false,
					json: null,
					portals: [],
					notifymv: null,
					dismissSecs: 5,
					dismissCountDown: 0,
					showDismissibleAlert: false
				},
				filters: {
					space (value) {
						return (value ? 'on' : 'off')
					},
					short (value) {
						return value.substr(0, value.indexOf('.'))
					},
					translateDoorState (value) {
						return (value ? 'GESCHLOSSEN' : 'OFFEN')
					},
					translateDoorLockState (value) {
						return (value ? 'VERRIEGELT' : 'ENTRIEGELT')
					},
					shortdate (value) {
						var date_now = new Date();
						var date_past = new Date(value);
						var days = date_past.getDate();
						var months = date_past.getMonth()+1;
						var hours = date_past.getHours();
						var minutes = date_past.getMinutes();
						
						days = days < 10 ? '0'+days : days;
						months = months < 10 ? '0'+months : months;
						hours = hours < 10 ? '0'+hours : hours;
						minutes = minutes < 10 ? '0'+minutes : minutes;
						var strDate = days + '.' + months + '.';
						var strTime = hours + ':' + minutes;
						
						var diff = date_now.getTime() - date_past.getTime();
						var diff_hours = Math.floor(diff / (1000 * 60 * 60));
						
						return ((diff_hours > 22) ? strDate + " " + strTime : strTime);
					},
					translateName(value){
						var txt;
						switch (value) {
							case "housedoor":
								txt = "Haustür";
								break;
							case "garagedoor":
								txt = "Garagentür";
								break;
							case "garagedoorlock":
								txt = "Garagentür";
								break;
							case "housedoorlock":
								txt = "Haustür";
								break;			  
							case "garage":
								txt = "Garage";
								break;
							default:
								txt = value;
						}
						return txt;
					}
				},
				methods: {
					getRealtimeData() {
						socket.on('portal', json => { //get button status from client
							this.json = json,
							this.portals = json.portals;
							this.socketState = true;
							console.log("socket connect: " + this.socketState);
						}),
						socket.on('disconnect', socketState => {
							this.socketState = false
							console.log('socket disconnect: ' + socketState);
						});
					},
					stateToTagListBgVV(value){
						//console.log("stateToTagListBg: " + value);
						return (!value ? 'green lighten-4' : 'red lighten-4')
					},
					stateToTagBg(value){
						return (value ? 'bg-success' : 'bg-danger')
					},
					stateToTag(value){
						return (value ? 'green' : 'red')
					},
					stateToTagVV(value){
						return (value ? 'text-danger' : 'text-success')
					},
					capitalizeFirstLetter(value) {
						return value.charAt(0).toUpperCase() + value.slice(1)
					},
					halfOrFull(value){
						//console.log("halfOrFull: " + value);
						var ret;
						switch (value) {	  
							case "garage":
							ret = "w-100";
							break;
							default:
							ret = "w-50";
						}
						return ret;
					},
					incrementItem: function(item) {return item + 1},
					warn: function (message, event) {
						// now we have access to the native event
						if (event) {
							event.preventDefault()
						}
						console.log("Waking " + message)
						socket.emit("wakemac", message) //send push button status to back to server
					},
					cancel() {
						this.$refs.modal.close("button");
					},
					isLast (index) {      
						return this.portals.length === index + 1
					},
					isLastRounded (index) {      
						return (this.isLast(index) ? 'rounded-bottom' : 'rounded-bottom-0')
					},
					notifyMvmnt: function (name, action, secs, event) {
						// now we have access to the native event
						if (event) {
							event.preventDefault()
						}
						//if (typeof mac !== 'undefined'){ 
						console.log(action + " " + name + " " + secs)
						//socket.emit("wakemac", mac); //send push button status to back to server
						//app.notifywol = "Waking " + hostname.substr(0, hostname.indexOf('.')) + " in " + this.dismissCountDown + " ..."
						//this.notifymv = hostname.substr(0, hostname.indexOf('.'))
						this.dismissSecs = secs
						this.notifymv = "... " + action + " "
						//setTimeout(() => this.isHidden = false, 5000)
						//setTimeout(() => this.notifywol = null, this.dismissSecs*1000+1000)
						//}
						this.dismissCountDown = this.dismissSecs
						//app.notifywol = null;
					},
					notifyMvmntCancel() {
						this.dismissSecs = 0
						this.dismissCountDown = 0
						this.showDismissibleAlert= false
					},
					countDownChanged(dismissCountDown) {
						this.dismissCountDown = dismissCountDown
					}
				},
				created () {
					this.getRealtimeData()
				},
				/*computed: {
					fullName: function () {
					return this.firstName + ' ' + this.lastName
					}	
				}*/
			})
		</script>
	</body>
</html>
